import{j as I,b4 as Z,u as J,az as K,r as b,b8 as X,b9 as ee,ba as te,bb as ne,aB as T,b7 as ae,bc as w,bd as G,be as H,bf as oe}from"./index-Be9AV8zH.js";var g=(e=>(e.PATIENT_AGE="patientAge",e.YEAR_OF_TREATMENT="yearOfTreatment",e.PATIENT_FULL_NAME="patientFullName",e.PATIENT_DOB_AGE="patientDobAge",e.PATIENT_DOB_YEAR="patientDobYear",e.PATIENT_CAREER="patientCareer",e.PATIENT_ADDRESS="patientAddress",e.PATIENT_GENDER="patientGender",e.SURGERY_DATE="surgeryDate",e.PATIENT_DOB="patientDob",e.PATIENT_PHONE_NUMBER="patientPhoneNumber",e.PATIENT_ADMISSION_DATE="patientAdmissionDate",e.TODAY_DATE="todayDate",e))(g||{});const re={male:{text:"Nam",value:1},female:{text:"Nữ",value:2},other:{text:"Khác",value:3},notProvided:{text:"Không cung cấp",value:0}},se=e=>Object.values(re).find(a=>a.value===e)?.text,V=async e=>{try{const t=await fetch(`http://localhost:8088/public/assets/printtemplates/${e}/pages.json`,{cache:"no-cache"}).then(l=>l.json()),a=await Promise.all(t.map(l=>fetch(`http://localhost:8088/public/assets/printtemplates/${e}/${l}`,{cache:"no-cache"})));return(await Promise.all(a.map(l=>l.text()))).map((l,E)=>{const c=new DOMParser().parseFromString(l,"text/html").querySelector(".a4-page");if(c){const A=c.getAttribute("data-page-index")??E.toString();return c.querySelectorAll("[data-field]").forEach(R=>{R.setAttribute("data-page-index",A)}),c.outerHTML}else return console.warn(`No .a4-page found in page ${E}`),l}).join(`
`)}catch(t){return console.error("Error loading template content:",t),""}},U=async()=>await fetch("http://localhost:8088/public/assets/printtemplates/base.html",{cache:"no-cache"}).then(t=>t.text()).catch(t=>(console.log(t),"")),Ee=()=>I.jsx(I.Fragment,{children:I.jsx(me,{})}),ce=e=>{const t=new Date(e),a=new Date;let s=a.getFullYear()-t.getFullYear();return a.getMonth()>t.getMonth()||a.getMonth()===t.getMonth()&&a.getDate()>=t.getDate()||s--,s};function ie(e,t){setTimeout(()=>{try{const a=t.body.scrollHeight,s=t.body.scrollWidth;e.style.height=`${a}px`,e.style.width=`${s}px`,e.style.opacity="1"}catch(a){console.warn("Cannot resize iframe:",a)}},0)}function le(e,t,a,s){setTimeout(()=>{t.body.querySelector(".content-container").innerHTML=a,ie(e,t),s({action:T.FinishLoadPagesToIframe})},333)}function N(e){const t=e.current;if(!t)return null;const a=t.contentDocument||t.contentWindow?.document;return a||null}function ue(e){const t={};for(const a of e){const{pageId:s,fields:p}=a;t[s]={};for(const l of p){const{name:E,...h}=l;t[s][E]=h}}return t}function z(e,t,a){const s=e.querySelectorAll(`[data-field="${t}"]`);a===`
`||a==="\r"||a==="\u2028"?s.forEach(p=>{p.innerHTML="<br>"}):s.forEach(p=>{p.textContent=a})}function de(e){const t=typeof e=="string"?new Date(e):e,a=w(t,"dd"),s=w(t,"MM"),p=w(t,"yyyy");return`Ngày ${a} tháng ${s} năm ${p}`}const fe=()=>{const e=Z(),{selectedPatientCode:t}=J(),a=K(),[s,p]=b.useState(null),[l,E]=b.useState(null),[h,D]=b.useState(1),c=b.useRef(null),A=b.useRef(null),{data:F}=X({documentId:e.documentId,patientCode:t}),{data:R}=ee({patientCode:t});b.useEffect(()=>{const o=N(c);if(o){if(A.current){const n=o.querySelector(`[data-field="${A.current}"][data-page-index="${h}"]`);if(n){n.classList.remove("bg-warning");const r=n.textContent?.trim().toLowerCase();if(!r||r===n.getAttribute("data-suggestion")){const i=n.getAttribute("data-default-value");i?(i===`
`||i==="\r"||i==="\u2028"?n.innerHTML="<br>":n.textContent=i,z(o,A.current,i)):n.textContent=""}}}if(l){const n=o.querySelector(`[data-field="${l}"][data-page-index="${h}"]`);if(n&&(n.classList.add("bg-warning"),!n.textContent?.trim())){const i=n.getAttribute("data-suggestion");i&&(n.textContent=i)}}A.current=l}},[l,A.current]);const S=async(o,n)=>{let r=N(c);if(r)switch(n){case G[0].key:{electron.ipcRenderer.send(H.PRINT_DOCUMENT,{htmlContent:r.body.innerHTML});break}case G[1].key:{const i=await electron.ipcRenderer.invoke("show-save-dialog",{title:"Save PDF file",defaultPath:"document.pdf",filters:[{name:"PDF Files",extensions:["pdf"]}]});if(!i)return;electron.ipcRenderer.send(H.PRINT_TO_PDF,{filePath:i,htmlContent:r.body.innerHTML});break}}},k=o=>{const n=N(c);if(!n)return;const r=n.getElementById(`page_${o}`);r?r.scrollIntoView({behavior:"smooth"}):console.log("Element not found inside iframe")},$=ne((o,n,r)=>{const i=N(c);if(!i)return;const f=i.querySelector(`[data-field="${o}"][data-page-index="${h}"]`);if(f){const x=n||r;f.textContent=x,z(i,o,x)}},333),v=o=>{const n=N(c);if(n)for(const[r,i]of Object.entries(s)){const f=s[r],x=n.querySelector(`#${r}`);if(console.log(f),!x||!f)continue;const _=o[r];for(const[P,O]of Object.entries(f)){const u=x.querySelector(`[data-field=${P}]`);if(!u)continue;let m;(_||f)&&(m=!!_&&_[P]||f[P].text||f[P].defaultValue),m?u.textContent=m:u.textContent=u.getAttribute("data-default-value")||""}}},Y=o=>{!o||!o.pageIndex||!o.fieldName||(k(o.pageIndex),D(o.pageIndex),E(o.fieldName))};return te(o=>{if(!o)return;const n=o.data;switch(o.action){case T.PrintDocument:S(n.documentName,n.printType);break;case T.OnChangeDocumentPage:if(!n||!n.pageIndex)return;k(n.pageIndex),D(n.pageIndex);break;case T.OnChangeFieldEditorValueChange:$(n.fieldName,n.newFieldValue,n.defaultFieldValue);break;case T.OnFocusFieldEditor:Y(n);break;case T.OnBlurFieldEditor:E(null);break;case T.LoadDocumentDataForIframe:const r=n.documentData||{};v(r);break}},[S,$,Y,E,D,v]),b.useEffect(()=>{if(!F||!c.current)return;const o=ae[F.data.documentType]?.toLowerCase();Promise.all([U(),V(o)]).then(([n,r])=>{const i=c.current,f=N(c);if(!f)return;f.open(),f.write(n),le(i,f,r,a),f.close();const _=new DOMParser().parseFromString(r,"text/html"),P=Array.from(_.querySelectorAll('[id^="page_"]')).filter(M=>/^page_\d+$/.test(M.id));let O=[];const u=R.data;let m={fullName:u.fullName.trim(),dob:u.dob?w(u.dob,"dd/MM/yyyy"):"",dobYear:u.dob?new Date(u.dob).getFullYear():"",age:u.dob?`${ce(u.dob)}`:"",address:u.address||"",gender:se(u.gender||0),phoneNumber:u.phone||"",career:u.career||""},L=w(new Date,"dd/MM/yyyy"),Q=de(new Date);for(const M of P){const j=Array.from(M.querySelectorAll("[data-field]"));if(!j.length)continue;let q=[];for(const C of j){let y={};const W=C.getAttribute("data-field");y.name=C.getAttribute("data-field"),y.type=C.getAttribute("data-type")||"text";let d;switch(W){case g.PATIENT_AGE:d=m.age;break;case g.PATIENT_FULL_NAME:d=m.fullName;break;case g.YEAR_OF_TREATMENT:d=`${new Date().getFullYear()}`;break;case g.PATIENT_DOB_AGE:d=`${m.dob} - ${m.age} tuổi`;break;case g.PATIENT_ADDRESS:d=m.address;break;case g.PATIENT_GENDER:d=m.gender;break;case g.SURGERY_DATE:d=L;break;case g.PATIENT_DOB:d=m.dob;break;case g.PATIENT_PHONE_NUMBER:d=m.phoneNumber;break;case g.PATIENT_ADMISSION_DATE:d=L;break;case g.TODAY_DATE:d=Q;break;case g.PATIENT_CAREER:d=m.career;break;case g.PATIENT_DOB_YEAR:d=m.dobYear;break;default:d="";break}y.text=d,y.defaultValue=d||"",y.suggestionValue=C.getAttribute("data-suggestion"),y.dataCaption=C.getAttribute("data-caption")||"",q.push(y)}O.push({pageId:M.id,fields:q})}const B=ue(O);p(B),console.log("flattenedSchema",B),a({action:T.CreateEditDocumentFields,data:O})})},[U,V,R,F,c.current]),I.jsx("iframe",{title:"document detail",className:"overflow-hidden opacity-5 mt-12",ref:c,src:"about:blank"})},me=()=>{const[e,t]=b.useState(1),[a,s]=b.useState(100),p=K(),l=b.useRef(null),E=(D,c,A)=>{s(c)},h=(D,c)=>{t(c),p({action:T.OnChangeDocumentPage,data:{pageIndex:c}})};return I.jsx(oe,{pageIndex:e,onPageChange:h,zoomValue:a,onPageZoom:E,nodeRef:l,children:I.jsx(fe,{})})};export{Ee as DocumentView};
