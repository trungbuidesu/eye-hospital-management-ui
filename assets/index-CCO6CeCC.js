import{j as O,b4 as ee,u as te,az as Z,r as A,b8 as ne,b9 as ae,ba as oe,bb as re,aB as h,b7 as se,bc as $,bd as U,be as z,bf as ce}from"./index-4NPSZKqw.js";var g=(e=>(e.PATIENT_AGE="patientAge",e.YEAR_OF_TREATMENT="yearOfTreatment",e.PATIENT_FULL_NAME="patientFullName",e.PATIENT_DOB_AGE="patientDobAge",e.PATIENT_DOB_YEAR="patientDobYear",e.PATIENT_CAREER="patientCareer",e.PATIENT_ADDRESS="patientAddress",e.PATIENT_GENDER="patientGender",e.SURGERY_DATE="surgeryDate",e.PATIENT_DOB="patientDob",e.PATIENT_PHONE_NUMBER="patientPhoneNumber",e.PATIENT_ADMISSION_DATE="patientAdmissionDate",e.TODAY_DATE="todayDate",e))(g||{});const ie={male:{text:"Nam",value:1},female:{text:"Nữ",value:2},other:{text:"Khác",value:3},notProvided:{text:"Không cung cấp",value:0}},le=e=>Object.values(ie).find(a=>a.value===e)?.text,k={BASE_API_URL:"http://localhost:8088",BASE_STATIC_HOST:"https://raw.githubusercontent.com/trungbuidesu/eye-hospital-static/refs/heads/main"},K=async e=>{try{const t=await fetch(`${k.BASE_STATIC_HOST}/print_templates/${e}/pages.json?t=${Date.now()}`,{cache:"no-store"}).then(i=>i.json()),a=await Promise.all(t.map(i=>fetch(`${k.BASE_STATIC_HOST}/print_templates/${e}/${i}?t=${Date.now()}`,{cache:"no-store"})));return(await Promise.all(a.map(i=>i.text()))).map(i=>{const E=new DOMParser().parseFromString(i,"text/html"),_=Array.from(E.querySelectorAll(".a4-page"));return _.sort((d,S)=>{const b=parseInt(d.querySelector("[data-page-index]")?.getAttribute("data-page-index")||"0",10),x=parseInt(S.querySelector("[data-page-index]")?.getAttribute("data-page-index")||"0",10);return b-x}),_.map(d=>{if(d.hasAttribute("data-page-index")){const b=d.getAttribute("data-page-index");return d.querySelectorAll("[data-field]").forEach(R=>R.setAttribute("data-page-index",b)),d.outerHTML}return d.querySelectorAll("[data-page-index]").forEach(b=>{const x=b.getAttribute("data-page-index")??"";b.querySelectorAll("[data-field]").forEach(B=>B.setAttribute("data-page-index",x))}),d.outerHTML}).join(`
`)}).join(`
`)}catch(t){return console.error("Error loading template content:",t),""}},Q=async()=>await fetch(`${k.BASE_STATIC_HOST}/print_templates/base.html`,{cache:"no-cache"}).then(t=>t.text()).catch(t=>(console.log(t),"")),be=()=>O.jsx(O.Fragment,{children:O.jsx(Te,{})}),ue=e=>{const t=new Date(e),a=new Date;let r=a.getFullYear()-t.getFullYear();return a.getMonth()>t.getMonth()||a.getMonth()===t.getMonth()&&a.getDate()>=t.getDate()||r--,r};function de(e,t){setTimeout(()=>{try{const a=t.body.scrollHeight,r=t.body.scrollWidth;e.style.height=`${a}px`,e.style.width=`${r}px`,e.style.opacity="1"}catch(a){console.warn("Cannot resize iframe:",a)}},0)}function fe(e,t,a,r){setTimeout(()=>{t.body.querySelector(".content-container").innerHTML=a,de(e,t),r({action:h.FinishLoadPagesToIframe})},333)}function w(e){const t=e.current;if(!t)return null;const a=t.contentDocument||t.contentWindow?.document;return a||null}function ge(e){const t={};for(const a of e){const{pageId:r,fields:p}=a;t[r]={};for(const i of p){const{name:y,...E}=i;t[r][y]=E}}return t}function W(e,t,a){const r=e.querySelectorAll(`[data-field="${t}"]`);a===`
`||a==="\r"||a==="\u2028"?r.forEach(p=>{p.innerHTML="<br>"}):r.forEach(p=>{p.textContent=a})}function pe(e){const t=typeof e=="string"?new Date(e):e,a=$(t,"dd"),r=$(t,"MM"),p=$(t,"yyyy");return`Ngày ${a} tháng ${r} năm ${p}`}const me=()=>{const e=ee(),{selectedPatientCode:t}=te(),a=Z(),[r,p]=A.useState(null),[i,y]=A.useState(null),[E,_]=A.useState(1),l=A.useRef(null),d=A.useRef(null),{data:S}=ne({documentId:e.documentId,patientCode:t}),{data:b}=ae({patientCode:t});A.useEffect(()=>{const o=w(l);if(o){if(d.current){const n=o.querySelector(`[data-field="${d.current}"][data-page-index="${E}"]`);if(n){n.classList.remove("bg-warning");const s=n.textContent?.trim().toLowerCase();if(!s||s===n.getAttribute("data-suggestion")){const c=n.getAttribute("data-default-value");c?(c===`
`||c==="\r"||c==="\u2028"?n.innerHTML="<br>":n.textContent=c,W(o,d.current,c)):n.textContent=""}}}if(i){const n=o.querySelector(`[data-field="${i}"][data-page-index="${E}"]`);if(n&&(n.classList.add("bg-warning"),!n.textContent?.trim())){const c=n.getAttribute("data-suggestion");c&&(n.textContent=c)}}d.current=i}},[i,d.current]);const x=async(o,n)=>{let s=w(l);if(s)switch(n){case U[0].key:{electron.ipcRenderer.send(z.PRINT_DOCUMENT,{htmlContent:s.body.innerHTML});break}case U[1].key:{const c=await electron.ipcRenderer.invoke("show-save-dialog",{title:"Save PDF file",defaultPath:"document.pdf",filters:[{name:"PDF Files",extensions:["pdf"]}]});if(!c)return;electron.ipcRenderer.send(z.PRINT_TO_PDF,{filePath:c,htmlContent:s.body.innerHTML});break}}},R=o=>{const n=w(l);if(!n)return;const s=n.getElementById(`page_${o}`);s?s.scrollIntoView({behavior:"smooth"}):console.log("Element not found inside iframe")},B=re((o,n,s)=>{const c=w(l);if(!c)return;const f=c.querySelector(`[data-field="${o}"][data-page-index="${E}"]`);if(f){const D=n||s;f.textContent=D,W(c,o,D)}},333),L=o=>{const n=w(l);if(n)for(const[s,c]of Object.entries(r)){const f=r[s],D=n.querySelector(`#${s}`);if(console.log(f),!D||!f)continue;const N=o[s];for(const[F,v]of Object.entries(f)){const C=D.querySelector(`[data-field=${F}]`);if(!C)continue;let I;(N||f)&&(I=!!N&&N[F]||f[F].text||f[F].defaultValue),I?C.textContent=I:C.textContent=C.getAttribute("data-default-value")||""}}},Y=o=>{!o||!o.pageIndex||!o.fieldName||(R(o.pageIndex),_(o.pageIndex),y(o.fieldName))};return oe(o=>{if(!o)return;const n=o.data;switch(o.action){case h.PrintDocument:x(n.documentName,n.printType);break;case h.OnChangeDocumentPage:if(!n||!n.pageIndex)return;R(n.pageIndex),_(n.pageIndex);break;case h.OnChangeFieldEditorValueChange:B(n.fieldName,n.newFieldValue,n.defaultFieldValue);break;case h.OnFocusFieldEditor:Y(n);break;case h.OnBlurFieldEditor:y(null);break;case h.LoadDocumentDataForIframe:const s=n.documentData||{};L(s);break}},[x,B,Y,y,_,L]),A.useEffect(()=>{if(!S||!l.current)return;const o=se[S.data.documentType]?.toLowerCase();Promise.all([Q(),K(o)]).then(([n,s])=>{const c=l.current,f=w(l);if(!f)return;let D=n.replaceAll("{BASE_STATIC_HOST}",k.BASE_STATIC_HOST),N=s.replaceAll("{BASE_STATIC_HOST}",k.BASE_STATIC_HOST);f.open(),f.write(D),fe(c,f,N,a),f.close();const v=new DOMParser().parseFromString(N,"text/html"),C=Array.from(v.querySelectorAll('[id^="page_"]')).filter(H=>/^page_\d+$/.test(H.id));let I=[];const m=b.data;let T={fullName:m.fullName.trim(),dob:m.dob?$(m.dob,"dd/MM/yyyy"):"",dobYear:m.dob?new Date(m.dob).getFullYear():"",age:m.dob?`${ue(m.dob)}`:"",address:m.address||"",gender:le(m.gender||0),phoneNumber:m.phone||"",career:m.career||""},q=$(new Date,"dd/MM/yyyy"),J=pe(new Date);for(const H of C){const G=Array.from(H.querySelectorAll("[data-field]"));if(!G.length)continue;let V=[];for(const M of G){let P={};const X=M.getAttribute("data-field");P.name=M.getAttribute("data-field"),P.type=M.getAttribute("data-type")||"text";let u;switch(X){case g.PATIENT_AGE:u=T.age;break;case g.PATIENT_FULL_NAME:u=T.fullName;break;case g.YEAR_OF_TREATMENT:u=`${new Date().getFullYear()}`;break;case g.PATIENT_DOB_AGE:u=`${T.dob} - ${T.age} tuổi`;break;case g.PATIENT_ADDRESS:u=T.address;break;case g.PATIENT_GENDER:u=T.gender;break;case g.SURGERY_DATE:u=q;break;case g.PATIENT_DOB:u=T.dob;break;case g.PATIENT_PHONE_NUMBER:u=T.phoneNumber;break;case g.PATIENT_ADMISSION_DATE:u=q;break;case g.TODAY_DATE:u=J;break;case g.PATIENT_CAREER:u=T.career;break;case g.PATIENT_DOB_YEAR:u=T.dobYear;break;default:u="";break}P.text=u,P.defaultValue=u||"",P.suggestionValue=M.getAttribute("data-suggestion"),P.dataCaption=M.getAttribute("data-caption")||"",V.push(P)}I.push({pageId:H.id,fields:V})}const j=ge(I);p(j),console.log("flattenedSchema",j),a({action:h.CreateEditDocumentFields,data:I})})},[Q,K,b,S,l.current]),O.jsx("iframe",{title:"document detail",className:"overflow-hidden opacity-5 mt-12",ref:l,src:"about:blank"})},Te=()=>{const[e,t]=A.useState(1),[a,r]=A.useState(100),p=Z(),i=A.useRef(null),y=(_,l,d)=>{r(l)},E=(_,l)=>{t(l),p({action:h.OnChangeDocumentPage,data:{pageIndex:l}})};return O.jsx(ce,{pageIndex:e,onPageChange:E,zoomValue:a,onPageZoom:y,nodeRef:i,children:O.jsx(me,{})})};export{be as DocumentView};
